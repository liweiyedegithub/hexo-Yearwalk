---
title: éº’éºŸV10ä¸­Docker å®¹å™¨æ–‡ä»¶æè¿°ç¬¦é™åˆ¶é—®é¢˜
date: 2024-04-02 10:14:56
tags: 
  - Docker
  - éº’éºŸV10
  - Java
top: false
categories: 
  - å›°éš¾è§£å†³
  - å›½äº§æ“ä½œç³»ç»Ÿ
img: /medias/featureimages/17.jpg

---
# ğŸ§© Docker å®¹å™¨æ–‡ä»¶æè¿°ç¬¦é™åˆ¶é—®é¢˜æ’æŸ¥è§£å†³
## ä¸€ã€é—®é¢˜æè¿°

åœ¨éº’éºŸV10 ç‰ˆæœ¬ä¸­è¿è¡Œ Java åº”ç”¨çš„ Docker å®¹å™¨ä¸­ï¼Œç³»ç»Ÿæ—¥å¿—ä¸­å‡ºç°ä»¥ä¸‹å¼‚å¸¸æˆ–å‘Šè­¦ä¿¡æ¯ï¼š

```
Too many open files
```

æˆ–åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œåº”ç”¨æ— æ³•æ­£å¸¸å»ºç«‹æ–°è¿æ¥ã€æ–‡ä»¶è¯»å†™å¤±è´¥ã€çº¿ç¨‹æ± å¼‚å¸¸é€€å‡ºã€‚  
è¿™æ˜¯ç”±äº **å®¹å™¨å†…æ–‡ä»¶æè¿°ç¬¦ï¼ˆulimit nofileï¼‰é™åˆ¶è¿‡ä½** å¯¼è‡´çš„ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker å®¹å™¨çš„ `nofile` é™åˆ¶å¯èƒ½ä»…ä¸º **1024**ï¼Œè¿œä½äºé«˜å¹¶å‘ Java åº”ç”¨æ‰€éœ€çš„æ–‡ä»¶å¥æŸ„æ•°é‡ã€‚

---

## äºŒã€é—®é¢˜åˆ†æ

### 1ï¸âƒ£ æ–‡ä»¶æè¿°ç¬¦çš„ä½œç”¨

Linux ä¸­æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶ã€ç½‘ç»œå¥—æ¥å­—ã€ç®¡é“ã€è®¾å¤‡ç­‰éƒ½å ç”¨ä¸€ä¸ª **æ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰**ã€‚  
Java åº”ç”¨åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ˆå¦‚ Web æœåŠ¡ã€æ•°æ®åº“è¿æ¥æ± ã€æ—¥å¿—å†™å…¥ç­‰ï¼‰ä¼šå¤§é‡ä½¿ç”¨ FDã€‚

å½“ FD æ•°é‡è¶…è¿‡ç³»ç»Ÿé™åˆ¶æ—¶ï¼Œç¨‹åºä¼šæŠ›å‡ºï¼š

```
java.io.FileNotFoundException: Too many open files
```

æˆ–ç³»ç»Ÿæ—¥å¿—ä¸­å‡ºç°ï¼š

```
EMFILE: Too many open files
```

---

### 2ï¸âƒ£ å®¹å™¨ä¸å®¿ä¸»æœºçš„é™åˆ¶å…³ç³»

Docker å®¹å™¨ç»§æ‰¿å®¿ä¸»æœºçš„éƒ¨åˆ†èµ„æºé™åˆ¶ï¼Œä½†å…¶å†…éƒ¨çš„ ulimit å‚æ•°å¯ä»¥ç‹¬ç«‹é…ç½®ã€‚

å¸¸è§é—®é¢˜æ¥æºï¼š

- Docker Daemon æœªé…ç½®å…¨å±€ ulimitï¼›
- å®¹å™¨å¯åŠ¨æ—¶æœªæ˜¾å¼å£°æ˜ï¼›
- å®¹å™¨å†… `/etc/security/limits.conf` æ— æ•ˆï¼›
- Compose æˆ– Kubernetes æœªä¼ é€’ ulimit å‚æ•°ã€‚

---

## ä¸‰ã€è§£å†³æ€è·¯

1. **ä»æ ¹æœ¬ä¸Šæé«˜ Docker å®¹å™¨å¯ç”¨æ–‡ä»¶æè¿°ç¬¦ä¸Šé™ï¼›**  
2. **ç¡®ä¿æ‰€æœ‰ Java åº”ç”¨å®¹å™¨åœ¨å¯åŠ¨æ—¶å‡ç»§æ‰¿è¯¥é…ç½®ã€‚**

---

## å››ã€è§£å†³æ­¥éª¤

### âœ… 1. ä¿®æ”¹ Docker Daemon å…¨å±€é…ç½®

ç¼–è¾‘ `/etc/docker/daemon.json`ï¼š

```json
{
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 262144,
      "Soft": 262144
    }
  },
  "oom-score-adjust": -500
}
```

> è¯´æ˜ï¼š
>
> - `default-ulimits`ï¼šè®¾ç½®æ‰€æœ‰å®¹å™¨çš„é»˜è®¤èµ„æºé™åˆ¶ï¼›
> - `nofile`ï¼šæ–‡ä»¶æè¿°ç¬¦æ•°é‡ï¼›
> - `oom-score-adjust`ï¼šé™ä½ Docker å®ˆæŠ¤è¿›ç¨‹è¢« OOM Killer æ€æ­»çš„æ¦‚ç‡ã€‚

ä¿å­˜åæ‰§è¡Œï¼š

```bash
sudo systemctl daemon-reexec
sudo systemctl restart docker
```

éªŒè¯æ˜¯å¦ç”Ÿæ•ˆï¼š

```bash
docker info | grep ulimits -A 3
```

---

### âœ… 2. åœ¨ docker-compose.yml ä¸­ä¸º Java å®¹å™¨å•ç‹¬è®¾ç½®é™åˆ¶

åœ¨å¯¹åº”æœåŠ¡ä¸­æ·»åŠ ï¼š

```yaml
services:
  my-java-app:
    image: my-java-app:latest
    container_name: java-app
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
```

> è¯´æ˜ï¼š
>
> - `soft`ï¼šè­¦å‘Šé˜ˆå€¼ï¼Œåº”ç”¨å¯åŠ¨æ€è°ƒæ•´ï¼›
> - `hard`ï¼šæœ€å¤§é™åˆ¶ï¼Œåº”ç”¨æ— æ³•è¶…å‡ºï¼›
> - å»ºè®®ä¸¤è€…ä¿æŒä¸€è‡´ï¼Œç¡®ä¿æœ€å¤§æ€§èƒ½ã€‚

é‡æ–°å¯åŠ¨å®¹å™¨ï¼š

```bash
docker-compose down
docker-compose up -d
```

éªŒè¯ï¼š

```bash
docker exec -it java-app bash
ulimit -n
```

åº”æ˜¾ç¤ºï¼š

```
262144
```

---

### âœ… 3. é’ˆå¯¹å•å®¹å™¨å¯åŠ¨æ–¹å¼ï¼ˆdocker runï¼‰

å¦‚æœæœªä½¿ç”¨ Composeï¼Œå¯ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­è®¾ç½®ï¼š

```bash
docker run -d   --name java-app   --ulimit nofile=262144:262144   my-java-app:latest
```

---

## äº”ã€éªŒè¯ç»“æœ

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å®¹å™¨å†…å½“å‰é™åˆ¶ï¼š

```bash
docker exec -it java-app bash
ulimit -a
```

è¾“å‡ºåº”åŒ…å«ï¼š

```
open files                      (-n) 262144
```
